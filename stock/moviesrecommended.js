"use strict";define(["events","layoutManager","inputManager","userSettings","libraryMenu","mainTabsManager","cardBuilder","dom","imageLoader","playbackManager","globalize","emby-scroller","emby-itemscontainer","emby-tabs","emby-button"],(function(events,layoutManager,inputManager,userSettings,libraryMenu,mainTabsManager,cardBuilder,dom,imageLoader,playbackManager,globalize){function enableScrollX(){return!layoutManager.desktop}function getPortraitShape(){return enableScrollX()?"overflowPortrait":"portrait"}function getRecommendationHtml(recommendation){var html="",title="";switch(recommendation.RecommendationType){case"SimilarToRecentlyPlayed":title=globalize.translate("RecommendationBecauseYouWatched",recommendation.BaselineItemName);break;case"SimilarToLikedItem":title=globalize.translate("RecommendationBecauseYouLike",recommendation.BaselineItemName);break;case"HasDirectorFromRecentlyPlayed":case"HasLikedDirector":title=globalize.translate("RecommendationDirectedBy",recommendation.BaselineItemName);break;case"HasActorFromRecentlyPlayed":case"HasLikedActor":title=globalize.translate("RecommendationStarring",recommendation.BaselineItemName)}html+='<div class="verticalSection">',html+='<h2 class="sectionTitle sectionTitle-cards padded-left">'+title+"</h2>";return enableScrollX()?(html+='<div is="emby-scroller" class="padded-top-focusscale padded-bottom-focusscale" data-mousewheel="false" data-centerfocus="true">',html+='<div is="emby-itemscontainer" class="itemsContainer scrollSlider focuscontainer-x">'):html+='<div is="emby-itemscontainer" class="itemsContainer focuscontainer-x padded-left padded-right vertical-wrap">',html+=cardBuilder.getCardsHtml(recommendation.Items,{shape:getPortraitShape(),scalable:!0,overlayPlayButton:!0,allowBottomPadding:!0,showTitle:!0,showYear:!0,centerText:!0}),enableScrollX()&&(html+="</div>"),html+="</div>",html+="</div>"}function autoFocus(page){require(["autoFocuser"],(function(autoFocuser){autoFocuser.autoFocus(page)}))}function loadSuggestionsTab(view,params,tabContent){var parentId=params.topParentId,userId=ApiClient.getCurrentUserId();console.debug("loadSuggestionsTab"),function loadResume(page,userId,parentId){var screenWidth=dom.getWindowSize().innerWidth,options={SortBy:"DatePlayed",SortOrder:"Descending",IncludeItemTypes:"Movie",Filters:"IsResumable",Limit:screenWidth>=1920||screenWidth>=1600?5:3,Recursive:!0,Fields:"PrimaryImageAspectRatio,MediaSourceCount,BasicSyncInfo",CollapseBoxSetItems:!1,ParentId:parentId,ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop,Banner,Thumb",EnableTotalRecordCount:!1};ApiClient.getItems(userId,options).then((function(result){result.Items.length?page.querySelector("#resumableSection").classList.remove("hide"):page.querySelector("#resumableSection").classList.add("hide");var allowBottomPadding=!enableScrollX(),container=page.querySelector("#resumableItems");cardBuilder.buildCards(result.Items,{itemsContainer:container,preferThumb:!0,shape:enableScrollX()?"overflowBackdrop":"backdrop",scalable:!0,overlayPlayButton:!0,allowBottomPadding:allowBottomPadding,cardLayout:!1,showTitle:!0,showYear:!0,centerText:!0}),autoFocus(page)}))}(tabContent,userId,parentId),function loadLatest(page,userId,parentId){var options={IncludeItemTypes:"Movie",Limit:18,Fields:"PrimaryImageAspectRatio,MediaSourceCount,BasicSyncInfo",ParentId:parentId,ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop,Banner,Thumb",EnableTotalRecordCount:!1};ApiClient.getJSON(ApiClient.getUrl("Users/"+userId+"/Items/Latest",options)).then((function(items){var allowBottomPadding=!enableScrollX(),container=page.querySelector("#recentlyAddedItems");cardBuilder.buildCards(items,{itemsContainer:container,shape:getPortraitShape(),scalable:!0,overlayPlayButton:!0,allowBottomPadding:allowBottomPadding,showTitle:!0,showYear:!0,centerText:!0}),autoFocus(page)}))}(tabContent,userId,parentId),function loadSuggestions(page,userId,parentId){var screenWidth=dom.getWindowSize().innerWidth,url=ApiClient.getUrl("Movies/Recommendations",{userId:userId,categoryLimit:6,ItemLimit:screenWidth>=1920||screenWidth>=1600?8:screenWidth>=1200?6:5,Fields:"PrimaryImageAspectRatio,MediaSourceCount,BasicSyncInfo",ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop,Banner,Thumb"});ApiClient.getJSON(url).then((function(recommendations){if(!recommendations.length)return page.querySelector(".noItemsMessage").classList.remove("hide"),void(page.querySelector(".recommendations").innerHTML="");var html=recommendations.map(getRecommendationHtml).join("");page.querySelector(".noItemsMessage").classList.add("hide");var recs=page.querySelector(".recommendations");recs.innerHTML=html,imageLoader.lazyChildren(recs),autoFocus(page)}))}(tabContent,userId)}function getTabs(){return[{name:globalize.translate("Movies")},{name:globalize.translate("TabSuggestions")},{name:globalize.translate("TabTrailers")},{name:globalize.translate("TabFavorites")},{name:globalize.translate("TabCollections")},{name:globalize.translate("TabGenres")},{name:globalize.translate("ButtonSearch"),cssClass:"searchTabButton"}]}return function(view,params){function onBeforeTabChange(e){!function preLoadTab(page,index){getTabController(page,index,(function(controller){-1==renderedTabs.indexOf(index)&&controller.preRender&&controller.preRender()}))}(view,parseInt(e.detail.selectedTabIndex))}function onTabChange(e){var newIndex=parseInt(e.detail.selectedTabIndex);!function loadTab(page,index){currentTabIndex=index,getTabController(page,index,(function(controller){null,-1==renderedTabs.indexOf(index)&&(renderedTabs.push(index),controller.renderTab())}))}(view,newIndex)}function getTabContainers(){return view.querySelectorAll(".pageTabContent")}function getTabController(page,index,callback){var depends=[];switch(index){case 0:depends.push("controllers/movies/movies");break;case 1:break;case 2:depends.push("controllers/movies/movietrailers");break;case 3:depends.push("controllers/movies/movies");break;case 4:depends.push("controllers/movies/moviecollections");break;case 5:depends.push("controllers/movies/moviegenres");break;case 6:depends.push("scripts/searchtab")}require(depends,(function(controllerFactory){var tabContent;index===suggestionsTabIndex&&(tabContent=view.querySelector(".pageTabContent[data-index='"+index+"']"),self.tabContent=tabContent);var controller=tabControllers[index];controller||(tabContent=view.querySelector(".pageTabContent[data-index='"+index+"']"),controller=index===suggestionsTabIndex?self:6===index?new controllerFactory(view,tabContent,{collectionType:"movies",parentId:params.topParentId}):0==index||3==index?new controllerFactory(view,params,tabContent,{mode:index?"favorites":"movies"}):new controllerFactory(view,params,tabContent),tabControllers[index]=controller,controller.initTab&&controller.initTab()),callback(controller)}))}function onPlaybackStop(e,state){state.NowPlayingItem&&"Video"==state.NowPlayingItem.MediaType&&(renderedTabs=[],mainTabsManager.getTabsElement().triggerTabChange())}function onInputCommand(e){switch(e.detail.command){case"search":e.preventDefault(),Dashboard.navigate("search.html?collectionType=movies&parentId="+params.topParentId)}}var self=this,currentTabIndex=parseInt(params.tab||function getDefaultTabIndex(folderId){switch(userSettings.get("landing-"+folderId)){case"suggestions":return 1;case"favorites":return 3;case"collections":return 4;case"genres":return 5;default:return 0}}(params.topParentId)),suggestionsTabIndex=1;self.initTab=function(){!function initSuggestedTab(page,tabContent){for(var elem,containers=tabContent.querySelectorAll(".itemsContainer"),i=0,length=containers.length;i<length;i++)elem=containers[i],enableScrollX()?(elem.classList.add("hiddenScrollX"),layoutManager.tv&&(elem.classList.add("smoothScrollX"),elem.classList.add("padded-top-focusscale"),elem.classList.add("padded-bottom-focusscale")),elem.classList.add("scrollX"),elem.classList.remove("vertical-wrap")):(elem.classList.remove("hiddenScrollX"),elem.classList.remove("smoothScrollX"),elem.classList.remove("scrollX"),elem.classList.add("vertical-wrap"))}(0,view.querySelector(".pageTabContent[data-index='"+suggestionsTabIndex+"']"))},self.renderTab=function(){var tabContent=view.querySelector(".pageTabContent[data-index='"+suggestionsTabIndex+"']");loadSuggestionsTab(0,params,tabContent)};var tabControllers=[],renderedTabs=[];view.addEventListener("viewshow",(function(e){if(e.detail.isRestored,function initTabs(){mainTabsManager.setTabs(view,currentTabIndex,getTabs,getTabContainers,onBeforeTabChange,onTabChange)}(),!view.getAttribute("data-title")){var parentId=params.topParentId;parentId?ApiClient.getItem(ApiClient.getCurrentUserId(),parentId).then((function(item){view.setAttribute("data-title",item.Name),libraryMenu.setTitle(item.Name)})):(view.setAttribute("data-title",globalize.translate("TabMovies")),libraryMenu.setTitle(globalize.translate("TabMovies")))}events.on(playbackManager,"playbackstop",onPlaybackStop),inputManager.on(window,onInputCommand)})),view.addEventListener("viewbeforehide",(function(e){inputManager.off(window,onInputCommand)})),view.addEventListener("viewdestroy",(function(e){tabControllers.forEach((function(t){t.destroy&&t.destroy()}))}))}}));